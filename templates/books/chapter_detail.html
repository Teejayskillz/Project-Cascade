{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ chapter.title }} by {{ chapter.story.author.username }} - Book JRA{% endblock %}

{% block meta_description %}
    Read Chapter {{ chapter.order }}: "{{ chapter.title }}" from the story "{{ chapter.story.title }}" by {{ chapter.story.author.username }}.
{% endblock meta_description %}

{% block extra_head %}
<style>
    /* Main Reading Container */
    .reading-container {
        max-width: 900px;
        margin: 2rem auto;
        padding: 3rem 2rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Breadcrumb Navigation */
    .custom-breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 2rem;
    }
    
    .custom-breadcrumb .breadcrumb-item a {
        color: var(--netflix-red);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .custom-breadcrumb .breadcrumb-item a:hover {
        color: var(--netflix-dark-red);
    }
    
    .custom-breadcrumb .breadcrumb-item.active {
        color: var(--medium-gray);
    }

    /* Chapter Header */
    .chapter-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .chapter-title {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        font-size: 2.5rem;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }
    
    .story-link {
        font-size: 1rem;
        color: var(--medium-gray);
        text-decoration: none;
        transition: color 0.3s ease;
    }
    
    .story-link:hover {
        color: var(--text-dark);
    }

    /* Article Content */
    .chapter-content {
        line-height: 1.9;
        font-size: 1.15rem;
        color: var(--text-dark);
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .chapter-content p {
        margin-bottom: 1.5rem;
    }
    
    .chapter-content h1, .chapter-content h2, .chapter-content h3 {
        font-family: 'Playfair Display', serif;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
    }
    
    /* Navigation Buttons */
    .chapter-nav {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chapter-nav-btn {
        display: inline-block;
        padding: 12px 25px;
        border-radius: 25px;
        background-color: #f1f1f1;
        color: var(--text-dark);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        min-width: 150px;
        text-align: center;
    }
    
    .chapter-nav-btn:hover {
        background: var(--netflix-red);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(229, 9, 20, 0.2);
    }
    
    .edit-link-container {
        text-align: center;
        margin-top: 2rem;
    }
    
    .edit-chapter-link {
        color: var(--netflix-red);
        font-weight: 600;
        transition: color 0.3s ease;
        text-decoration: none;
    }
    
    .edit-chapter-link:hover {
        color: var(--netflix-dark-red);
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container py-5">
    <div class="reading-container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb custom-breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'books:story-detail' slug=chapter.story.slug %}">{{ chapter.story.title }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ chapter.title }}</li>
            </ol>
        </nav>
        
        <div class="chapter-header">
            <h1 class="chapter-title">{{ chapter.title }}</h1>
            <a href="{% url 'users:user_profile' username=chapter.story.author.username %}" class="story-link">
                By {{ chapter.story.author.username }}
            </a>
        </div>
        
        <article class="chapter-content">
            {{ chapter.content|safe }}
        </article>
        
        {% if user == chapter.story.author %}
        <div class="edit-link-container">
            <a href="{% url 'books:chapter-edit' story_pk=chapter.story.pk chapter_pk=chapter.pk %}" class="edit-chapter-link">
                <i class="fas fa-edit me-1"></i> Edit this Chapter
            </a>
        </div>
        {% endif %}

        <div class="chapter-nav">
            {% if previous_chapter %}
            <div>
                <a href="{% url 'books:chapter-detail' story_pk=previous_chapter.story.pk chapter_pk=previous_chapter.pk %}"
                   class="chapter-nav-btn">
                    <i class="fas fa-arrow-left me-2"></i>Previous Chapter
                </a>
            </div>
            {% endif %}

            {% if next_chapter %}
            <div>
                <a href="{% url 'books:chapter-detail' story_pk=next_chapter.story.pk chapter_pk=next_chapter.pk %}"
                   class="chapter-nav-btn">
                    Next Chapter<i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
  const STORY_ID = {{ chapter.story.id }};
  const CHAPTER_ID = {{ chapter.id }};
  const CSRF = "{{ csrf_token }}";

  /* 1.  restore on load */
  fetch(`/api/story/${STORY_ID}/progress/`)
    .then(r => r.json())
    .then(data => {
      // Corrected URL: Use a variable or a correct Django URL tag
      if (data.chapter_id && data.chapter_id !== CHAPTER_ID) {
        // This part needs to be handled on the server-side to generate the correct URL
        // A simple JavaScript solution is to dynamically replace the chapter ID
        location.href = "{% url 'books:chapter-detail' story_pk=chapter.story.pk chapter_pk=999999 %}".replace('999999', data.chapter_id);
      } else {
        window.scrollTo({top: data.scroll, behavior: 'smooth'});
      }
    });

  /* 2.  auto-save while reading */
  let lastPos = window.pageYOffset;
  let timer;
  function save() {
    fetch(`/api/story/${STORY_ID}/save/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': CSRF},
      body: JSON.stringify({
        chapter_id: CHAPTER_ID,
        scroll: window.pageYOffset,
        char: 0
      })
    });
  }
  window.addEventListener('scroll', () => {
    if (Math.abs(window.pageYOffset - lastPos) < 60) return;
    lastPos = window.pageYOffset;
    clearTimeout(timer);
    timer = setTimeout(save, 2000);   // 2-second debounce
  });
</script>
{% endblock %}